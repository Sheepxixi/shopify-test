# å¤šæ–‡ä»¶ä¸Šä¼ ã€å­˜å‚¨å’Œä¸‹è½½è¯¦è§£

> æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ç³»ç»Ÿä¸­å¤šæ–‡ä»¶ä¸Šä¼ ã€å­˜å‚¨å’Œä¸‹è½½çš„å®Œæ•´å®ç°æœºåˆ¶

---

## ğŸ“‹ ç›®å½•

1. [å¤šæ–‡ä»¶ä¸Šä¼ æµç¨‹](#å¤šæ–‡ä»¶ä¸Šä¼ æµç¨‹)
2. [æ–‡ä»¶å­˜å‚¨æœºåˆ¶](#æ–‡ä»¶å­˜å‚¨æœºåˆ¶)
3. [æ–‡ä»¶ä¸è®¢å•å…³è”](#æ–‡ä»¶ä¸è®¢å•å…³è”)
4. [å¤šæ–‡ä»¶ä¸‹è½½æœºåˆ¶](#å¤šæ–‡ä»¶ä¸‹è½½æœºåˆ¶)
5. [å…³é”®æŠ€æœ¯ç»†èŠ‚](#å…³é”®æŠ€æœ¯ç»†èŠ‚)
6. [ä»£ç ç¤ºä¾‹](#ä»£ç ç¤ºä¾‹)

---

## å¤šæ–‡ä»¶ä¸Šä¼ æµç¨‹

### 1. å‰ç«¯æ–‡ä»¶ç®¡ç†æ¶æ„

#### æ–‡ä»¶ç®¡ç†å™¨ (fileManager)

```javascript
let fileManager = {
  files: new Map(),              // å­˜å‚¨æ‰€æœ‰æ–‡ä»¶åŠå…¶é…ç½®
  currentFileId: null,           // å½“å‰é€‰ä¸­çš„æ–‡ä»¶ID
  nextFileId: 1,                 // ä¸‹ä¸€ä¸ªæ–‡ä»¶IDï¼ˆè‡ªå¢ï¼‰
  fileAssociations: new Map()     // æ–‡ä»¶å…³è”å…³ç³»ï¼š3Dæ–‡ä»¶ID -> 2Dæ–‡ä»¶IDæ•°ç»„
};
```

**æ•°æ®ç»“æ„**:
```javascript
fileManager.files.set(fileId, {
  id: fileId,                    // æ–‡ä»¶IDï¼ˆæ•°å­—ï¼‰
  file: Fileå¯¹è±¡,                // åŸå§‹æ–‡ä»¶å¯¹è±¡
  config: {                      // æ–‡ä»¶é…ç½®
    material: 'ABS',
    quantity: 1,
    surfaceTreatments: [...],
    // ... å…¶ä»–å‚æ•°
  },
  dimensions: {                  // 3Dæ¨¡å‹å°ºå¯¸ï¼ˆå¦‚æœå¯è§£æï¼‰
    width: 100,
    height: 50,
    depth: 25
  },
  model: THREE.Meshå¯¹è±¡          // 3Dæ¨¡å‹å¯¹è±¡ï¼ˆå¦‚æœå·²åŠ è½½ï¼‰
});
```

---

### 2. æ–‡ä»¶é€‰æ‹©å’Œå¤„ç†

#### 2.1 æ–‡ä»¶é€‰æ‹©å…¥å£

**æ”¯æŒä¸¤ç§æ–¹å¼**:
1. **ç‚¹å‡»ä¸Šä¼ **: é€šè¿‡ `<input type="file" multiple>` é€‰æ‹©
2. **æ‹–æ‹½ä¸Šä¼ **: æ‹–æ‹½æ–‡ä»¶åˆ° dropzone åŒºåŸŸ

```javascript
// å¤„ç†æ–‡ä»¶é€‰æ‹©
function handleFileSelect(event) {
  const files = Array.from(event.target.files);
  processFiles(files);
}

// å¤„ç†æ‹–æ‹½
function handleDrop(event) {
  event.preventDefault();
  const files = Array.from(event.dataTransfer.files);
  processFiles(files);
}
```

#### 2.2 æ–‡ä»¶éªŒè¯

**éªŒè¯è§„åˆ™**:
- **æ–‡ä»¶æ•°é‡**: æœ€å¤š20ä¸ªæ–‡ä»¶
- **æ–‡ä»¶å¤§å°**: å•ä¸ªæ–‡ä»¶æœ€å¤§100MB
- **æ–‡ä»¶æ ¼å¼**: 
  - 3Dæ–‡ä»¶: STP, STEP, STL, OBJ, 3MF, IGES, GLB, GLTF
  - 2Dæ–‡ä»¶: DWG, DXF, PDF
  - å‹ç¼©åŒ…: ZIP, RAR

```javascript
async function processFiles(files) {
  if (files.length === 0) return;
  
  // éªŒè¯æ–‡ä»¶æ•°é‡
  if (files.length > 20) {
    throw new Error('å•æ¬¡æœ€å¤šåªèƒ½ä¸Šä¼ 20ä¸ªæ–‡ä»¶');
  }
  
  // é€ä¸ªå¤„ç†æ–‡ä»¶
  for (const file of files) {
    // éªŒè¯æ–‡ä»¶å¤§å°
    if (file.size > 100 * 1024 * 1024) {
      throw new Error(`æ–‡ä»¶ "${file.name}" è¶…è¿‡100MBé™åˆ¶`);
    }
    
    // å¤„ç†å•ä¸ªæ–‡ä»¶
    await processSingleFile(file);
  }
}
```

#### 2.3 æ–‡ä»¶ç±»å‹å¤„ç†

**ä¸‰ç§å¤„ç†è·¯å¾„**:

1. **ZIPæ–‡ä»¶**: è‡ªåŠ¨è§£å‹ï¼Œæå–å…¶ä¸­çš„æœ‰æ•ˆæ–‡ä»¶
```javascript
async function processZipFile(zipFile) {
  // ä½¿ç”¨JSZipåº“è§£å‹
  const zip = new JSZip();
  const zipData = await zip.loadAsync(fileData);
  
  // æå–æ‰€æœ‰æ–‡ä»¶
  for (const [relativePath, zipEntry] of Object.entries(zipData.files)) {
    if (!zipEntry.dir && isValidFileName(relativePath)) {
      const fileData = await zipEntry.async('blob');
      const extractedFile = new File([fileData], relativePath, { type: getMimeType(relativePath) });
      await processRegularFile(extractedFile);
    }
  }
}
```

2. **3Dæ–‡ä»¶**: æ·»åŠ åˆ°æ–‡ä»¶ç®¡ç†å™¨ï¼Œå°è¯•åŠ è½½3Dé¢„è§ˆ
```javascript
async function processRegularFile(file) {
  const fileId = fileManager.nextFileId++;
  
  // å­˜å‚¨æ–‡ä»¶
  fileManager.files.set(fileId, {
    id: fileId,
    file: file,
    config: createDefaultFileConfig(),
    dimensions: null,
    model: null
  });
  
  // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼Œè®¾ä¸ºå½“å‰æ–‡ä»¶
  if (!fileManager.currentFileId) {
    fileManager.currentFileId = fileId;
  }
  
  // å¼‚æ­¥åŠ è½½3Dæ¨¡å‹ï¼ˆä¸é˜»å¡ï¼‰
  loadModelForFile(fileId).catch(err => console.error(err));
  
  return fileId;
}
```

3. **2Dæ–‡ä»¶**: æ·»åŠ åˆ°æ–‡ä»¶ç®¡ç†å™¨ï¼Œå…³è”åˆ°å¯¹åº”çš„3Dæ–‡ä»¶
```javascript
// 2Dæ–‡ä»¶å¤„ç†é€»è¾‘
if (is2DFile(file.name)) {
  // æŸ¥æ‰¾å¯¹åº”çš„3Dæ–‡ä»¶ï¼ˆé€šè¿‡æ–‡ä»¶ååŒ¹é…ï¼‰
  const corresponding3DFile = findCorresponding3DFile(file.name);
  
  if (corresponding3DFile) {
    // å»ºç«‹å…³è”å…³ç³»
    const associations = fileManager.fileAssociations.get(corresponding3DFile.id) || [];
    associations.push(fileId);
    fileManager.fileAssociations.set(corresponding3DFile.id, associations);
  }
}
```

---

### 3. æ–‡ä»¶é€‰æ‹©æœºåˆ¶

#### 3.1 æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º

```javascript
function displayFileList() {
  // æ˜¾ç¤ºæ‰€æœ‰æ–‡ä»¶
  fileManager.files.forEach((fileData, fileId) => {
    const is3D = is3DFile(fileData.file.name);
    const is2D = is2DFile(fileData.file.name);
    
    // æ¸²æŸ“æ–‡ä»¶é¡¹
    const fileItem = createFileItemElement({
      fileId,
      fileName: fileData.file.name,
      fileSize: formatFileSize(fileData.file.size),
      is3D,
      is2D,
      isSelected: selectedFileIds.has(fileId)
    });
    
    fileItems.appendChild(fileItem);
  });
}
```

#### 3.2 æ–‡ä»¶é€‰æ‹©ï¼ˆå‹¾é€‰ï¼‰

```javascript
// é€‰ä¸­çš„æ–‡ä»¶IDé›†åˆ
const selectedFileIds = new Set();

// å‹¾é€‰/å–æ¶ˆå‹¾é€‰æ–‡ä»¶
function toggleFileSelection(fileId) {
  if (selectedFileIds.has(fileId)) {
    selectedFileIds.delete(fileId);
  } else {
    const fileData = fileManager.files.get(fileId);
    // åªå…è®¸é€‰æ‹©3Dæ–‡ä»¶
    if (fileData && is3DFile(fileData.file.name)) {
      selectedFileIds.add(fileId);
    }
  }
  updateBulkButtonState();
}
```

**é€‰æ‹©è§„åˆ™**:
- âœ… åªèƒ½é€‰æ‹©3Dæ–‡ä»¶
- âœ… 2Dæ–‡ä»¶è‡ªåŠ¨å…³è”åˆ°å¯¹åº”çš„3Dæ–‡ä»¶
- âœ… å¯ä»¥å¤šé€‰
- âœ… è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶æ‰èƒ½æäº¤

---

## æ–‡ä»¶å­˜å‚¨æœºåˆ¶

### 1. ä¸Šä¼ æµç¨‹æ¦‚è§ˆ

```
å‰ç«¯é€‰æ‹©æ–‡ä»¶
  â†“
è½¬æ¢ä¸ºBase64
  â†“
POST /api/store-file-real
  â†“
åç«¯: Shopify Staged Upload
  â†“
ä¸Šä¼ åˆ°ä¸´æ—¶åœ°å€
  â†“
åˆ›å»ºæ°¸ä¹…æ–‡ä»¶è®°å½•
  â†“
åˆ›å»º uploaded_file Metaobject
  â†“
è¿”å›æ–‡ä»¶IDå’ŒURL
```

---

### 2. å‰ç«¯ä¸Šä¼ å‡½æ•°

#### 2.1 æ–‡ä»¶è½¬Base64

```javascript
async function getFileBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      // è¿”å›å®Œæ•´çš„Data URL: "data:application/step;base64,U1RFUCBGSUxF..."
      resolve(reader.result);
    };
    reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
    reader.readAsDataURL(file);
  });
}
```

#### 2.2 ä¸Šä¼ åˆ°Shopify Files

```javascript
async function uploadToShopifyFiles(file) {
  console.log('ğŸ“¤ ä¸Šä¼ æ–‡ä»¶åˆ° /api/store-file-real:', file.name, file.type, file.size);
  
  // 1. è½¬æ¢ä¸ºBase64
  const readerResult = await getFileBase64(file);
  
  // 2. è°ƒç”¨ä¸Šä¼ API
  const resp = await fetch(`${API_BASE}/store-file-real`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      fileData: readerResult,        // Base64æ•°æ®
      fileName: file.name,           // åŸå§‹æ–‡ä»¶å
      fileType: file.type || 'application/octet-stream'
    }),
  });
  
  if (!resp.ok) {
    const text = await resp.text();
    throw new Error(`ä¸Šä¼ æ–‡ä»¶å¤±è´¥ (${resp.status})`);
  }
  
  const json = await resp.json();
  
  // 3. è¿”å›æ–‡ä»¶å…ƒæ•°æ®
  return {
    fileId: json.fileId,                    // å†…éƒ¨æ–‡ä»¶ID
    shopifyFileId: json.shopifyFileId,       // Shopify File ID
    shopifyFileUrl: json.shopifyFileUrl,     // CDN URL
    originalFileSize: json.originalFileSize  // æ–‡ä»¶å¤§å°
  };
}
```

---

### 3. åç«¯å­˜å‚¨å®ç°

#### 3.1 æ¥æ”¶å’Œè§£æ

```javascript
// api/store-file-real.js
export default async function handler(req, res) {
  const { fileData, fileName, fileType } = req.body;
  
  // è§£æBase64æ•°æ®
  const base64Data = fileData.includes(',') 
    ? fileData.split(',')[1]  // å»æ‰ "data:application/step;base64," å‰ç¼€
    : fileData;
  
  const fileBuffer = Buffer.from(base64Data, 'base64');
  const fileSize = fileBuffer.length;
  
  // ç¡®å®šæ–‡ä»¶ç±»å‹
  const contentCategory = determineContentCategory(fileType, fileName);
  // MODEL_3D æˆ– FILE
  const resourceType = contentCategory === 'MODEL_3D' ? 'MODEL_3D' : 'FILE';
}
```

#### 3.2 Shopify Staged Upload

**æ­¥éª¤1: åˆ›å»ºStaged Upload**

```javascript
const stagedUploadMutation = `
  mutation stagedUploadsCreate($input: [StagedUploadInput!]!) {
    stagedUploadsCreate(input: $input) {
      stagedTargets {
        url              # ä¸´æ—¶ä¸Šä¼ URL
        resourceUrl      # æ°¸ä¹…èµ„æºURLï¼ˆä¸Šä¼ åä½¿ç”¨ï¼‰
        parameters {     # ä¸Šä¼ å‚æ•°ï¼ˆpolicy, signatureç­‰ï¼‰
          name
          value
        }
      }
      userErrors { field message }
    }
  }
`;

const stagedUploadResponse = await fetch(`https://${storeDomain}/admin/api/2024-01/graphql.json`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-Shopify-Access-Token': accessToken
  },
  body: JSON.stringify({
    query: stagedUploadMutation,
    variables: {
      input: [{
        filename: fileName,
        mimeType: stagedMimeType,
        resource: resourceType  // MODEL_3D æˆ– FILE
      }]
    }
  })
});
```

**æ­¥éª¤2: ä¸Šä¼ æ–‡ä»¶åˆ°ä¸´æ—¶åœ°å€**

```javascript
const stagedTarget = stagedUploadData.data.stagedUploadsCreate.stagedTargets[0];
const parameters = stagedTarget.parameters;

// åˆ¤æ–­ä¸Šä¼ æ–¹å¼ï¼ˆS3é£æ ¼ æˆ– GCS Signed URLï¼‰
const hasPolicy = parameters.some(param => param.name === 'policy');

if (hasPolicy) {
  // S3é£æ ¼ï¼šmultipart/form-data
  const boundary = `----formdata-${Date.now()}`;
  const parts = [];
  
  // æ·»åŠ æ‰€æœ‰å‚æ•°
  parameters.forEach(param => {
    parts.push(`--${boundary}\r\n`);
    parts.push(`Content-Disposition: form-data; name="${param.name}"\r\n\r\n`);
    parts.push(`${param.value}\r\n`);
  });
  
  // æ·»åŠ æ–‡ä»¶
  parts.push(`--${boundary}\r\n`);
  parts.push(`Content-Disposition: form-data; name="file"; filename="${fileName}"\r\n`);
  parts.push(`Content-Type: ${mimeType}\r\n\r\n`);
  
  const uploadBuffer = Buffer.concat([
    Buffer.from(parts.join(''), 'utf8'),
    fileBuffer,
    Buffer.from(`\r\n--${boundary}--\r\n`, 'utf8')
  ]);
  
  uploadResponse = await fetch(stagedTarget.url, {
    method: 'POST',
    headers: {
      'Content-Type': `multipart/form-data; boundary=${boundary}`,
      'Content-Length': uploadBuffer.length.toString()
    },
    body: uploadBuffer
  });
} else {
  // GCS Signed URLï¼šç›´æ¥PUTæ–‡ä»¶
  uploadResponse = await fetch(stagedTarget.url, {
    method: 'PUT',
    headers: {
      'Content-Type': fileType || 'application/octet-stream'
    },
    body: fileBuffer
  });
}
```

**æ­¥éª¤3: åˆ›å»ºæ°¸ä¹…æ–‡ä»¶è®°å½•**

```javascript
const fileCreateMutation = `
  mutation fileCreate($files: [FileCreateInput!]!) {
    fileCreate(files: $files) {
      files {
        id
        fileStatus
        ... on GenericFile {
          url                    # CDN URL
          originalFileSize        # æ–‡ä»¶å¤§å°
        }
      }
      userErrors { field message }
    }
  }
`;

const fileCreateResponse = await fetch(`https://${storeDomain}/admin/api/2024-01/graphql.json`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-Shopify-Access-Token': accessToken
  },
  body: JSON.stringify({
    query: fileCreateMutation,
    variables: {
      files: [{
        originalSource: stagedTarget.resourceUrl,  // ä½¿ç”¨resourceUrl
        contentType: resourceType,                 // MODEL_3D æˆ– FILE
        alt: fileName
      }]
    }
  })
});

const fileRecord = fileCreateData.data.fileCreate.files[0];
const shopifyFileUrl = fileRecord.url;           // CDN URL
const shopifyFileId = fileRecord.id;             // Shopify File ID
```

**æ­¥éª¤4: åˆ›å»º uploaded_file Metaobject**

```javascript
const fileId = `file_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

const metaobjectCreateMutation = `
  mutation createUploadedFile($metaobject: MetaobjectCreateInput!) {
    metaobjectCreate(metaobject: $metaobject) {
      metaobject { id }
      userErrors { field message }
    }
  }
`;

const metaInput = {
  type: 'uploaded_file',
  handle: fileId,
  fields: [
    { key: 'file_id', value: fileId },
    { key: 'file_name', value: fileName },
    { key: 'file_type', value: mimeType },
    { key: 'file_url', value: shopifyFileUrl },
    { key: 'shopify_file_id', value: shopifyFileId },
    { key: 'file_size', value: String(fileSize) },
    { key: 'upload_time', value: new Date().toISOString() }
  ]
};

await shopGql(metaobjectCreateMutation, { metaobject: metaInput });
```

**è¿”å›ç»“æœ**:
```json
{
  "success": true,
  "fileId": "file_1759114189482_jt19vrzqj",
  "shopifyFileId": "gid://shopify/GenericFile/123456",
  "shopifyFileUrl": "https://cdn.shopify.com/s/files/...",
  "originalFileSize": 683520
}
```

---

## æ–‡ä»¶ä¸è®¢å•å…³è”

### 1. å¤šæ–‡ä»¶è®¢å•åˆ›å»ºç­–ç•¥

**æ ¸å¿ƒç­–ç•¥**: **æ¯ä¸ª3Dæ–‡ä»¶åˆ›å»ºç‹¬ç«‹çš„Draft Order**

```
ç”¨æˆ·é€‰æ‹©3ä¸ª3Dæ–‡ä»¶ + 2ä¸ª2Dæ–‡ä»¶
  â†“
ä¸ºæ¯ä¸ª3Dæ–‡ä»¶åˆ›å»ºç‹¬ç«‹è®¢å•:
  - è®¢å•1: 3Dæ–‡ä»¶1 + å…³è”çš„2Dæ–‡ä»¶
  - è®¢å•2: 3Dæ–‡ä»¶2 + å…³è”çš„2Dæ–‡ä»¶
  - è®¢å•3: 3Dæ–‡ä»¶3 + å…³è”çš„2Dæ–‡ä»¶
```

---

### 2. æäº¤è¯¢ä»·æµç¨‹

#### 2.1 æ•´ä½“æµç¨‹

```javascript
async function submitToDraftOrder() {
  // 1. è·å–å®¢æˆ·ä¿¡æ¯
  const customerInfo = await getCustomerInfo();
  
  // 2. ç­›é€‰é€‰ä¸­çš„3Dæ–‡ä»¶
  const selected3DFileIds = Array.from(selectedFileIds).filter(id => {
    const fileData = fileManager.files.get(id);
    return fileData && is3DFile(fileData.file.name);
  });
  
  // 3. ä¸ºæ¯ä¸ª3Dæ–‡ä»¶åˆ›å»ºç‹¬ç«‹è®¢å•
  const draftOrderIds = [];
  
  for (const fileId of selected3DFileIds) {
    const fileData = fileManager.files.get(fileId);
    
    // 3.1 ä¸Šä¼ 3Dæ–‡ä»¶
    const threeDMeta = await uploadToShopifyFiles(fileData.file);
    
    // 3.2 æ„å»ºlineItemsæ•°ç»„
    const lineItems = [];
    
    // 3.2.1 æ·»åŠ 3Dæ–‡ä»¶çš„lineItem
    lineItems.push({
      title: fileData.file.name,
      quantity: config.quantity,
      price: 0,
      customAttributes: [
        { key: 'Order Type', value: '3D Model Quote' },
        { key: 'æ–‡ä»¶ç±»å‹', value: '3D' },
        { key: 'æ–‡ä»¶ID', value: threeDMeta.fileId },
        { key: 'Shopifyæ–‡ä»¶ID', value: threeDMeta.shopifyFileId },
        { key: 'Shopifyæ–‡ä»¶URL', value: threeDMeta.shopifyFileUrl },
        // ... å…¶ä»–å‚æ•°
      ]
    });
    
    // 3.2.2 æŸ¥æ‰¾å¹¶ä¸Šä¼ å…³è”çš„2Dæ–‡ä»¶
    const twoDFiles = getCorresponding2DFiles(fileId);
    for (const twoD of twoDFiles) {
      const twoDMeta = await uploadToShopifyFiles(twoD.file);
      
      lineItems.push({
        title: twoD.file.name,
        quantity: 1,
        price: 0,
        customAttributes: [
          { key: 'Order Type', value: '2D Drawing' },
          { key: 'æ–‡ä»¶ç±»å‹', value: '2D' },
          { key: 'å…³è”3Dæ–‡ä»¶', value: fileData.file.name },
          { key: 'æ–‡ä»¶ID', value: twoDMeta.fileId },
          { key: 'Shopifyæ–‡ä»¶ID', value: twoDMeta.shopifyFileId },
          { key: 'Shopifyæ–‡ä»¶URL', value: twoDMeta.shopifyFileUrl }
        ]
      });
    }
    
    // 3.3 åˆ›å»ºDraft Order
    const response = await fetch(`${API_BASE}/submit-quote-real`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        customerName: customerInfo.name,
        customerEmail: customerInfo.email,
        fileName: fileData.file.name,
        lineItems: lineItems  // åŒ…å«3Dæ–‡ä»¶ + æ‰€æœ‰å…³è”çš„2Dæ–‡ä»¶
      })
    });
    
    const result = await response.json();
    draftOrderIds.push(result.draftOrderId);
  }
  
  // 4. è¿”å›ç¬¬ä¸€ä¸ªè®¢å•IDï¼ˆç”¨äºè·³è½¬ï¼‰
  return draftOrderIds[0];
}
```

---

### 3. Draft Order ç»“æ„

#### 3.1 è®¢å•ç»“æ„ç¤ºä¾‹

```javascript
{
  id: "gid://shopify/DraftOrder/1234567890",
  name: "#D1001",
  email: "customer@example.com",
  lineItems: [
    {
      // 3Dæ–‡ä»¶
      title: "model.step",
      quantity: 1,
      originalUnitPrice: "0.00",
      customAttributes: [
        { key: "Order Type", value: "3D Model Quote" },
        { key: "æ–‡ä»¶ç±»å‹", value: "3D" },
        { key: "æ–‡ä»¶ID", value: "file_xxx" },
        { key: "Shopifyæ–‡ä»¶ID", value: "gid://shopify/GenericFile/123" },
        { key: "Shopifyæ–‡ä»¶URL", value: "https://cdn.shopify.com/..." },
        { key: "ææ–™", value: "ABS" },
        { key: "æ•°é‡", value: "10" }
        // ... å…¶ä»–å‚æ•°
      ]
    },
    {
      // å…³è”çš„2Dæ–‡ä»¶1
      title: "drawing.dwg",
      quantity: 1,
      originalUnitPrice: "0.00",
      customAttributes: [
        { key: "Order Type", value: "2D Drawing" },
        { key: "æ–‡ä»¶ç±»å‹", value: "2D" },
        { key: "å…³è”3Dæ–‡ä»¶", value: "model.step" },
        { key: "æ–‡ä»¶ID", value: "file_yyy" },
        { key: "Shopifyæ–‡ä»¶ID", value: "gid://shopify/GenericFile/456" },
        { key: "Shopifyæ–‡ä»¶URL", value: "https://cdn.shopify.com/..." }
      ]
    },
    {
      // å…³è”çš„2Dæ–‡ä»¶2
      title: "drawing.pdf",
      quantity: 1,
      originalUnitPrice: "0.00",
      customAttributes: [
        { key: "Order Type", value: "2D Drawing" },
        { key: "æ–‡ä»¶ç±»å‹", value: "2D" },
        { key: "å…³è”3Dæ–‡ä»¶", value: "model.step" },
        { key: "æ–‡ä»¶ID", value: "file_zzz" },
        { key: "Shopifyæ–‡ä»¶ID", value: "gid://shopify/GenericFile/789" },
        { key: "Shopifyæ–‡ä»¶URL", value: "https://cdn.shopify.com/..." }
      ]
    }
  ]
}
```

#### 3.2 æ–‡ä»¶å…³è”å…³ç³»

**é€šè¿‡ customAttributes å»ºç«‹å…³è”**:
- 3Dæ–‡ä»¶çš„ `customAttributes` åŒ…å«è‡ªå·±çš„æ–‡ä»¶ä¿¡æ¯
- 2Dæ–‡ä»¶çš„ `customAttributes` åŒ…å« `å…³è”3Dæ–‡ä»¶` å­—æ®µï¼ŒæŒ‡å‘å¯¹åº”çš„3Dæ–‡ä»¶å

---

## å¤šæ–‡ä»¶ä¸‹è½½æœºåˆ¶

### 1. å•ä¸ªæ–‡ä»¶ä¸‹è½½

#### 1.1 é€šè¿‡æ–‡ä»¶IDä¸‹è½½

```javascript
// api/download-file.js
export default async function handler(req, res) {
  const { id, shopifyFileId } = req.query;
  
  // æ–¹æ¡ˆ1: ç›´æ¥ä½¿ç”¨Shopify File ID
  if (shopifyFileId) {
    const query = `
      query($id: ID!) {
        node(id: $id) {
          ... on GenericFile {
            url
          }
        }
      }
    `;
    
    const result = await shopGql(query, { id: shopifyFileId });
    const fileUrl = result.data.node.url;
    
    // é‡å®šå‘åˆ°CDN URL
    res.writeHead(302, { Location: fileUrl });
    return res.end();
  }
  
  // æ–¹æ¡ˆ2: é€šè¿‡ uploaded_file Metaobject æŸ¥æ‰¾
  const fileRecord = await findFileMetaobject(id);
  const fileUrl = fileRecord.fields.find(f => f.key === 'file_url').value;
  
  // é‡å®šå‘åˆ°CDN URL
  res.writeHead(302, { Location: fileUrl });
  return res.end();
}
```

---

### 2. æ‰¹é‡æ–‡ä»¶ä¸‹è½½

#### 2.1 æ ¹æ®Draft Orderä¸‹è½½æ‰€æœ‰æ–‡ä»¶

```javascript
// api/download-order-files.js
export default async function handler(req, res) {
  const { draftOrderId } = req.query;
  
  // 1. æŸ¥è¯¢Draft Order
  const draftOrderQuery = `
    query($id: ID!) {
      draftOrder(id: $id) {
        lineItems(first: 50) {
          edges {
            node {
              title
              customAttributes {
                key
                value
              }
            }
          }
        }
      }
    }
  `;
  
  const draftOrder = await shopGql(draftOrderQuery, { id: draftOrderId });
  
  // 2. æå–æ‰€æœ‰æ–‡ä»¶ä¿¡æ¯
  const files = [];
  for (const edge of draftOrder.data.draftOrder.lineItems.edges) {
    const lineItem = edge.node;
    const attributes = lineItem.customAttributes;
    
    const getAttr = (key) => {
      const attr = attributes.find(a => a.key === key);
      return attr ? attr.value : null;
    };
    
    const fileName = lineItem.title;
    const shopifyFileUrl = getAttr('Shopifyæ–‡ä»¶URL');
    const fileId = getAttr('æ–‡ä»¶ID');
    
    if (shopifyFileUrl && shopifyFileUrl.startsWith('http')) {
      files.push({
        fileName,
        url: shopifyFileUrl,
        type: 'shopify_url'
      });
    } else if (fileId) {
      files.push({
        fileName,
        fileId,
        type: 'metaobject'
      });
    }
  }
  
  // 3. ä¸‹è½½æ‰€æœ‰æ–‡ä»¶å¹¶æ‰“åŒ…æˆZIP
  const JSZip = require('jszip');
  const zip = new JSZip();
  
  for (const file of files) {
    try {
      let fileBuffer;
      
      if (file.type === 'shopify_url') {
        // ä»Shopify CDNä¸‹è½½
        const response = await fetch(file.url);
        fileBuffer = Buffer.from(await response.arrayBuffer());
      } else if (file.type === 'metaobject') {
        // ä»Metaobjectè·å–
        const fileInfo = await getFileFromMetaobject(file.fileId);
        if (fileInfo.type === 'url') {
          const response = await fetch(fileInfo.url);
          fileBuffer = Buffer.from(await response.arrayBuffer());
        } else if (fileInfo.type === 'base64') {
          const base64Data = fileInfo.data.split(',')[1];
          fileBuffer = Buffer.from(base64Data, 'base64');
        }
      }
      
      // æ·»åŠ åˆ°ZIP
      zip.file(file.fileName, fileBuffer);
    } catch (error) {
      console.error(`æ–‡ä»¶ä¸‹è½½å¤±è´¥: ${file.fileName}`, error);
      // æ·»åŠ é”™è¯¯æ ‡è®°æ–‡ä»¶
      zip.file(`é”™è¯¯_${file.fileName}.txt`, `æ–‡ä»¶ä¸‹è½½å¤±è´¥: ${error.message}`);
    }
  }
  
  // 4. ç”ŸæˆZIPæ–‡ä»¶
  const zipBuffer = await zip.generateAsync({
    type: 'nodebuffer',
    compression: 'DEFLATE',
    compressionOptions: { level: 6 }
  });
  
  // 5. è¿”å›ZIPæ–‡ä»¶
  const zipFileName = `${draftOrder.name || 'order'}_files_${Date.now()}.zip`;
  
  res.setHeader('Content-Type', 'application/zip');
  res.setHeader('Content-Disposition', `attachment; filename="${encodeURIComponent(zipFileName)}"`);
  res.setHeader('Content-Length', zipBuffer.length);
  
  return res.status(200).send(zipBuffer);
}
```

#### 2.2 å‰ç«¯è°ƒç”¨

```javascript
// ä¸‹è½½è®¢å•æ‰€æœ‰æ–‡ä»¶
function downloadOrderFiles(draftOrderId) {
  const url = `${API_BASE}/download-order-files?draftOrderId=${encodeURIComponent(draftOrderId)}`;
  window.open(url);
  // æµè§ˆå™¨ä¼šè‡ªåŠ¨ä¸‹è½½ZIPæ–‡ä»¶
}
```

---

## å…³é”®æŠ€æœ¯ç»†èŠ‚

### 1. Base64ç¼–ç å¤„ç†

**ä¸ºä»€ä¹ˆä½¿ç”¨Base64?**
- HTTPåè®®åªèƒ½ä¼ è¾“æ–‡æœ¬æ•°æ®
- äºŒè¿›åˆ¶æ–‡ä»¶éœ€è¦è½¬æ¢ä¸ºæ–‡æœ¬æ ¼å¼
- Base64æ˜¯æ ‡å‡†çš„ç¼–ç æ–¹å¼ï¼Œæ‰€æœ‰æµè§ˆå™¨éƒ½æ”¯æŒ

**ç¼–ç æ ¼å¼**:
```
åŸå§‹æ ¼å¼: "data:application/step;base64,U1RFUCBGSUxF..."
          â””â”€â”¬â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          MIMEç±»å‹    Base64æ ‡è¯†    Base64æ•°æ®
```

**è§£ç å¤„ç†**:
```javascript
// å‰ç«¯å‘é€
const base64Data = reader.result;  // "data:application/step;base64,..."

// åç«¯æ¥æ”¶
const base64Payload = fileData.includes(',') 
  ? fileData.split(',')[1]  // å»æ‰å‰ç¼€
  : fileData;
const fileBuffer = Buffer.from(base64Payload, 'base64');
```

---

### 2. Shopify Staged Upload

**ä¸ºä»€ä¹ˆéœ€è¦Staged Upload?**
- ç›´æ¥ä¸Šä¼ å¤§æ–‡ä»¶åˆ°Shopify APIä¼šè¶…æ—¶
- Staged Uploadåˆ†ä¸¤æ­¥ï¼Œé¿å…è¶…æ—¶
- æ–‡ä»¶ä¸Šä¼ åˆ°Google Cloud Storageï¼Œé€Ÿåº¦æ›´å¿«

**ä¸¤ç§ä¸Šä¼ æ–¹å¼**:

1. **S3é£æ ¼** (multipart/form-data):
```javascript
// éœ€è¦æ„å»ºmultipartè¡¨å•
const boundary = `----formdata-${Date.now()}`;
const parts = [
  `--${boundary}\r\n`,
  `Content-Disposition: form-data; name="policy"\r\n\r\n`,
  `${policyValue}\r\n`,
  // ... å…¶ä»–å‚æ•°
  `--${boundary}\r\n`,
  `Content-Disposition: form-data; name="file"; filename="${fileName}"\r\n`,
  `Content-Type: ${mimeType}\r\n\r\n`,
  fileBuffer,
  `\r\n--${boundary}--\r\n`
];
```

2. **GCS Signed URL** (PUT):
```javascript
// ç›´æ¥PUTæ–‡ä»¶
await fetch(stagedTarget.url, {
  method: 'PUT',
  headers: {
    'Content-Type': fileType
  },
  body: fileBuffer
});
```

---

### 3. æ–‡ä»¶ç±»å‹åˆ¤æ–­

```javascript
function determineContentCategory(fileType, fileName) {
  const mime = (fileType || '').toLowerCase();
  const ext = (fileName || '').toLowerCase().split('.').pop();
  
  // 3Dæ¨¡å‹æ‰©å±•å
  const MODEL_EXTENSIONS = ['stl', 'obj', '3mf', 'glb', 'gltf', '3ds', 'ply'];
  
  if (mime.startsWith('image/')) return 'IMAGE';
  if (mime.startsWith('video/')) return 'VIDEO';
  if (mime.includes('model') && !['model/step', 'model/x.stp'].includes(mime)) {
    return 'MODEL_3D';
  }
  if (MODEL_EXTENSIONS.includes(ext)) return 'MODEL_3D';
  
  // STEP/STP æŒ‰ FILE å¤„ç†ï¼ˆShopifyä¸æ”¯æŒMODEL_3Dï¼‰
  return 'FILE';
}
```

**æ³¨æ„**: STEP/STPæ–‡ä»¶åœ¨Shopifyä¸­ä¸è¢«è¯†åˆ«ä¸ºMODEL_3Dï¼Œéœ€è¦æŒ‰FILEå¤„ç†ã€‚

---

### 4. æ–‡ä»¶å…³è”é€»è¾‘

**3Då’Œ2Dæ–‡ä»¶å…³è”**:
```javascript
// é€šè¿‡æ–‡ä»¶ååŒ¹é…
function findCorresponding3DFile(twoDFileName) {
  // ç§»é™¤æ‰©å±•å
  const baseName = twoDFileName.replace(/\.(dwg|dxf|pdf)$/i, '');
  
  // æŸ¥æ‰¾åŒ¹é…çš„3Dæ–‡ä»¶
  for (const [fileId, fileData] of fileManager.files) {
    if (is3DFile(fileData.file.name)) {
      const threeDBaseName = fileData.file.name.replace(/\.(stp|step|stl|obj)$/i, '');
      if (threeDBaseName.toLowerCase() === baseName.toLowerCase()) {
        return { id: fileId, ...fileData };
      }
    }
  }
  return null;
}
```

---

## ä»£ç ç¤ºä¾‹

### å®Œæ•´çš„å¤šæ–‡ä»¶ä¸Šä¼ ç¤ºä¾‹

```javascript
// 1. ç”¨æˆ·é€‰æ‹©å¤šä¸ªæ–‡ä»¶
const files = [file1, file2, file3];  // Fileå¯¹è±¡æ•°ç»„

// 2. å¤„ç†æ–‡ä»¶
for (const file of files) {
  const fileId = await processRegularFile(file);
  // fileId å­˜å‚¨åˆ° fileManager.files
}

// 3. ç”¨æˆ·å‹¾é€‰æ–‡ä»¶å¹¶æäº¤
const selectedFileIds = new Set([1, 2]);  // é€‰ä¸­fileId 1å’Œ2

// 4. æäº¤è¯¢ä»·
async function submitToDraftOrder() {
  const draftOrderIds = [];
  
  for (const fileId of selectedFileIds) {
    const fileData = fileManager.files.get(fileId);
    
    // 4.1 ä¸Šä¼ 3Dæ–‡ä»¶
    const threeDMeta = await uploadToShopifyFiles(fileData.file);
    
    // 4.2 æ„å»ºlineItems
    const lineItems = [{
      title: fileData.file.name,
      quantity: 1,
      customAttributes: [
        { key: 'æ–‡ä»¶ID', value: threeDMeta.fileId },
        { key: 'Shopifyæ–‡ä»¶URL', value: threeDMeta.shopifyFileUrl }
      ]
    }];
    
    // 4.3 æŸ¥æ‰¾å…³è”çš„2Dæ–‡ä»¶
    const twoDFiles = getCorresponding2DFiles(fileId);
    for (const twoD of twoDFiles) {
      const twoDMeta = await uploadToShopifyFiles(twoD.file);
      lineItems.push({
        title: twoD.file.name,
        customAttributes: [
          { key: 'æ–‡ä»¶ID', value: twoDMeta.fileId },
          { key: 'å…³è”3Dæ–‡ä»¶', value: fileData.file.name }
        ]
      });
    }
    
    // 4.4 åˆ›å»ºDraft Order
    const result = await fetch('/api/submit-quote-real', {
      method: 'POST',
      body: JSON.stringify({ lineItems })
    });
    
    draftOrderIds.push(result.draftOrderId);
  }
  
  return draftOrderIds[0];
}
```

---

## æ€»ç»“

### æ ¸å¿ƒç‰¹ç‚¹

1. **å¤šæ–‡ä»¶ç®¡ç†**: ä½¿ç”¨Mapå­˜å‚¨ï¼Œæ”¯æŒç‹¬ç«‹é…ç½®
2. **æ–‡ä»¶å…³è”**: 3Då’Œ2Dæ–‡ä»¶è‡ªåŠ¨å…³è”
3. **ç‹¬ç«‹è®¢å•**: æ¯ä¸ª3Dæ–‡ä»¶åˆ›å»ºç‹¬ç«‹çš„Draft Order
4. **æ‰¹é‡ä¸Šä¼ **: å¹¶è¡Œä¸Šä¼ å¤šä¸ªæ–‡ä»¶åˆ°Shopify Files
5. **æ‰¹é‡ä¸‹è½½**: æ”¯æŒæ‰“åŒ…æˆZIPä¸‹è½½

### æ•°æ®æµå‘

```
å‰ç«¯æ–‡ä»¶é€‰æ‹©
  â†“
æ–‡ä»¶ç®¡ç†å™¨ (fileManager)
  â†“
é€ä¸ªä¸Šä¼ åˆ° Shopify Files
  â†“
åˆ›å»º Draft Order (æ¯ä¸ª3Dæ–‡ä»¶ä¸€ä¸ªè®¢å•)
  â†“
lineItems åŒ…å«æ‰€æœ‰å…³è”æ–‡ä»¶
  â†“
é€šè¿‡ customAttributes å­˜å‚¨æ–‡ä»¶ä¿¡æ¯
  â†“
æ”¯æŒæ‰¹é‡ä¸‹è½½ (ZIPæ‰“åŒ…)
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-01-29

å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·å‚è€ƒä»£ç æ³¨é‡Šæˆ–ç›¸å…³æ–‡æ¡£ã€‚
